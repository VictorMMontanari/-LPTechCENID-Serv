
USER := ec2-user
# https://us-west-1.console.aws.amazon.com/ec2/v2/home?region=us-west-1#Instances:sort=instanceId
IP := 54.153.85.61
PEM := ~/Downloads/test123.pem

all:
	$(MAKE) upload
	ssh -i $(PEM) $(USER)@$(IP) "make build"
	$(MAKE) download
.PHONY: all

setup-ssh:
	chmod 600 $(PEM)
.PHONY: setup-ssh

#https://thenounproject.com/search/?q=land&i=1046425
ssh:
	ssh -i $(PEM) $(USER)@$(IP)
.PHONY: ssh

install:
	curl -s https://rpm.nodesource.com/setup_6.x | sudo bash -
	sudo yum install -y gcc-c++ nodejs
.PHONY: install

# Copy your code and package.json to the instance using scp and create a deployment package:
upload:
	scp -i $(PEM) ./index.js $(USER)@$(IP):/home/$(USER)/index.js
	scp -i $(PEM) ./package.json $(USER)@$(IP):/home/$(USER)/package.json
	scp -i $(PEM) ./Makefile $(USER)@$(IP):/home/$(USER)/Makefile
.PHONY: upload

download:
	scp -i $(PEM) $(USER)@$(IP):/home/$(USER)/download.zip ./download.zip
.PHONY: download

# Run on remote machine
build:
	npm install
	chmod 777 node_modules
	zip -ur9 ./download.zip index.js package.json node_modules
	chmod 777 download.zip
.PHONY: build
