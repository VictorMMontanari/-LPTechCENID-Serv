
module.exports = function(state, action, callback) {
  var dbaction = {
    type: 'MongoDB initialize',
    input: {}
  }
  var remaining = 0
  var changes = action.input.Changes

  state.dispatch(dbaction, function(err, db) {
    for (var collection in changes) {
      for (var id in changes[collection]) {
        var query = { _id: id }
        var updates = changes[collection][id]
        persist(db, collection, query, updates)
      }
    }
  })

  function persist(db, collection, query, updates) {
    remaining++
    db.collection(collection).update(query, { $set: updates }, { upsert: true }, function(err, doc){
      if (err) return callback(err)
      remaining--
      if (remaining === 0) {
        return callback()
      }
    })
  }
}
