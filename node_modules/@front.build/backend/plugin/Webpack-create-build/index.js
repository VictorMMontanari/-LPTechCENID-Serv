
var fs = require('fs')
// var MemoryFS = require('memory-fs')
var webpack = require('webpack')

module.exports = function(state, action, callback) {
  // //
  //       {
  //         type: 'NPM install',
  //         input: {
  //           'package.json': action.input['package.json']
  //         }
  //       },
  // var mfs = new MemoryFS()
  var index = action.input['index.js']
  var packageJSON = action.input['package.json']

  var config = {
    entry: '/index.js',
    output: '/build.js'
  }

  var compiler = webpack(config)
  fs.writeFileSync('/index.js', index)
  fs.writeFileSync('/package.json', packageJSON)
  // compiler.inputFileSystem = fs
  // compiler.outputFileSystem = mfs
  compiler.run(oncomplete)

  function oncomplete(err, stats) {
    if (err || stats.hasErrors()) {
      // Handle errors here
    }
    var info = stats.toJson()
    // Done processing
    if (stats.hasErrors()) {
      console.error(info.errors)
    }

    if (stats.hasWarnings()) {
      console.warn(info.warnings)
    }

    var code = fs.readFileSync('/build.js', 'utf-8')
    callback(null, code)
  }
}
