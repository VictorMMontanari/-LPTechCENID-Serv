
var https = require('https')
var URL = require('url-parse')

module.exports = function(state, action, callback) {
  var url = new URL(state.resolve(action.input['URL']))
  var method = state.resolve(action.input.Method)
  var headers = state.resolve(action.input.Headers)
  var body = state.resolve(action.input.Body)

  if (body) {
    headers['Content-length'] = body.length
  }

  var options = {
    method: method,
    hostname: url.hostname,
    port: url.port,
    path: url.pathname,
    protocol: url.protocol,
    auth: url.auth
  }

  if (headers) options.headers = headers

  var req = https.request(options, function(res){
    var body = ''
    res.setEncoding('utf8')
    res.on('data', function(data){
      body += data;
    });
    res.on('end', function(){
      callback(null, body)
    })
  })

  if (body) {
    req.write(body)
  }

  req.end()
}
