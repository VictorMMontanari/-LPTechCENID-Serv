
var to = require('to-case')

// https://stackoverflow.com/questions/39381139/how-to-stream-aws-lambda-response-in-node

module.exports = function(state, action, callback) {
  action = action.input.Action
  state.dispatch({ type: 'Lambda initialize' }, function(err, lambda){
    var params = {
      FunctionName: to.pascal(action.type),
      Payload: JSON.stringify(action)
      // LogType: "Tail" https://stackoverflow.com/questions/35754766/nodejs-invoke-an-aws-lambda-function-from-within-another-lambda-function
    }

    lambda.invoke(params, function(err, data){
      if (err) return callback(err)
      if (data.StatusCode >= 200 && data.StatusCode < 300) {
        let json = JSON.parse(data.Payload)
        if (data.errorMessage) {
          console.log(data)
          return callback(null, null)
        }
        callback(null, json)
      } else {
        console.log('data', data)
        callback(null, null)
      }
    })
  })
}
